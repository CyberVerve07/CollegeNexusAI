/**
 * This ruleset enforces a strict role-based access control (RBAC) model for a
 * college management application.
 *
 * Core Philosophy:
 * The security model is built around three user roles: ADMIN, TEACHER, and
 * STUDENT. Admins have broad management capabilities. Teachers can manage
 * content they create (e.g., study materials) and view assigned data. Students
 * can access their own personal data (e.g., attendance) and general academic
 * information. The default posture requires users to be authenticated to read
 * any data.
 *
 * Data Structure:
 * The structure mixes top-level public-read collections (like /courses, /notices)
 * with user-specific data collections (/users, /students, /teachers).
 * User-specific subcollections (e.g., /students/{studentId}/attendance) enforce
 * a clear ownership hierarchy. A dedicated /roles_admin collection is used for
 * efficient and secure administrator role checks.
 *
 * Key Security Decisions:
 * - Admin Role: A user is considered an admin if a corresponding document
 *   exists for them in the `/roles_admin` collection. This is a performant
 *   pattern that avoids storing roles on the user document itself.
 * - Public Data: General academic data (courses, subjects, notices, etc.) is
 *   readable by any authenticated user but can only be modified by Admins,
 *   or in some cases, the original content creator (e.g., a Teacher uploading
 *   study material).
 * - User Data Privacy: Users can only read and modify their own `/users/{userId}`
 *   document. Listing all users is strictly forbidden to prevent data scraping.
 *   Similarly, students and teachers can only access their specific documents
 *   in `/students` and `/teachers`.
 *
 * Denormalization for Authorization:
 * To create simpler, faster rules, data required for authorization is denormalized.
 * For example, a `StudyMaterial` document contains a `teacherId` field, and a
 * `QuestionPaper` contains an `uploaderId`. This allows for direct ownership
 * checks (`isOwner(resource.data.teacherId)`) without needing slow and costly
 * `get()` calls to other documents.
 *
 * Structural Segregation:
 * Different user types (`students`, `teachers`) are stored in separate top-level
 * collections. This simplifies rules and security for list operations, ensuring a
 * student cannot accidentally query teacher-specific information.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------------------------------------------
    // Helper Functions
    // --------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the authenticated user's UID matches the provided userId.
     * This is the primary function for establishing document ownership.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * Combines an ownership check with an existence check.
     * CRITICAL for all update and delete operations to prevent modifying
     * non-existent data.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Checks if the requesting user has an Admin role.
     * This is determined by the existence of a document in the roles_admin collection.
     */
    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    // --------------------------------------------------------------------
    // User and Role Management
    // --------------------------------------------------------------------

    /**
     * @description Manages user profile data. Users can create and manage their own
     *              profile. Admins can view any profile and delete accounts.
     * @path        /users/{userId}
     * @allow       A user (uid: 'user123') creates their own profile at `/users/user123`. (create)
     * @deny        A user (uid: 'user123') tries to read another user's profile at `/users/user456`. (get)
     * @principle   Restricts access to a user's own data tree and enforces self-creation.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId) || (isAdmin() && resource != null);
    }

    /**
     * @description Manages student-specific data records. Only Admins can create or modify
     *              these records. A student can read their own record.
     * @path        /students/{studentId}
     * @allow       A student (uid: 'student123') reads their own data at `/students/student123`. (get)
     * @deny        A teacher tries to create a new student record. (create)
     * @principle   Enforces admin-only management for critical student enrollment data.
     */
    match /students/{studentId} {
      allow get: if isOwner(studentId) || isAdmin();
      allow list: if false;
      allow create: if isAdmin() && request.resource.data.userId == studentId;
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Manages teacher-specific data records. Only Admins can create or modify
     *              these records. A teacher can read their own record.
     * @path        /teachers/{teacherId}
     * @allow       A teacher (uid: 'teacher123') reads their own data at `/teachers/teacher123`. (get)
     * @deny        A student tries to view a teacher's record. (get)
     * @principle   Enforces admin-only management for teacher data.
     */
    match /teachers/{teacherId} {
      allow get: if isOwner(teacherId) || isAdmin();
      allow list: if false;
      allow create: if isAdmin() && request.resource.data.userId == teacherId;
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Manages student attendance. A student can view their own attendance.
     *              Only Admins can create or modify attendance records.
     * @path        /students/{studentId}/attendance/{attendanceId}
     * @allow       A student (uid: 'student123') lists their attendance records. (list)
     * @deny        A teacher tries to create an attendance record for a student. (create)
     * @principle   Secures sensitive student data to the student themselves, with admin oversight.
     */
    match /students/{studentId}/attendance/{attendanceId} {
      allow get: if isOwner(studentId) || isAdmin();
      allow list: if isOwner(studentId) || isAdmin();
      allow create: if isAdmin() && request.resource.data.studentId == studentId;
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Manages the mapping of teachers to their subjects. Only Admins
     *              can create these assignments. Assigned teachers can view their own.
     * @path        /teacher_subjects/{teacherSubjectId}
     * @allow       An Admin creates a new teacher-subject assignment. (create)
     * @deny        A teacher tries to list all assignments for all teachers. (list)
     * @principle   Centralizes control of academic assignments to administrators.
     */
    match /teacher_subjects/{teacherSubjectId} {
      allow get: if (resource != null && isOwner(resource.data.teacherId)) || isAdmin();
      allow list: if false;
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description A special collection to grant Admin privileges. Existence of a
     *              document here makes a user an admin. Only admins can manage this list.
     * @path        /roles_admin/{userId}
     * @allow       An existing Admin adds a new user to the admin list. (create)
     * @deny        A regular user tries to read the list of admins. (get, list)
     * @principle   Implements a secure and performant role-lookup system.
     */
    match /roles_admin/{userId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    // --------------------------------------------------------------------
    // Academic Structure (Admin-Managed)
    // --------------------------------------------------------------------

    /**
     * @description Manages core academic structure like courses, batches, semesters,
     *              sections, and subjects. This data is readable by all signed-in users
     *              but is managed exclusively by Admins.
     * @path        /courses/{courseId} and its subcollections
     * @allow       A student reads the list of available courses. (list)
     * @deny        A teacher tries to add a new subject to a course. (create)
     * @principle   Protects foundational data integrity by restricting writes to Admins.
     */
    match /courses/{courseId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;

      match /batches/{batchId} {
        allow get: if isSignedIn();
        allow list: if isSignedIn();
        allow create: if isAdmin();
        allow update: if isAdmin() && resource != null;
        allow delete: if isAdmin() && resource != null;

        match /semesters/{semesterId} {
          allow get: if isSignedIn();
          allow list: if isSignedIn();
          allow create: if isAdmin();
          allow update: if isAdmin() && resource != null;
          allow delete: if isAdmin() && resource != null;

          match /sections/{sectionId} {
            allow get: if isSignedIn();
            allow list: if isSignedIn();
            allow create: if isAdmin();
            allow update: if isAdmin() && resource != null;
            allow delete: if isAdmin() && resource != null;
          }
        }
      }

      match /subjects/{subjectId} {
        allow get: if isSignedIn();
        allow list: if isSignedIn();
        allow create: if isAdmin();
        allow update: if isAdmin() && resource != null;
        allow delete: if isAdmin() && resource != null;
      }
    }

    // --------------------------------------------------------------------
    // Public Content Collections
    // --------------------------------------------------------------------

    /**
     * @description Manages study materials uploaded by teachers. All signed-in users
     *              can read materials. Only the original teacher can create, update, or delete.
     * @path        /subjects/{subjectId}/study_materials/{studyMaterialId}
     * @allow       A teacher (uid: 'teacher123') creates a new study material with `teacherId: 'teacher123'`. (create)
     * @deny        A teacher tries to delete another teacher's study material. (delete)
     * @principle   Enforces document ownership for writes on publicly readable content.
     */
    match /subjects/{subjectId}/study_materials/{studyMaterialId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.teacherId == request.auth.uid;
      allow update: if resource != null && isOwner(resource.data.teacherId);
      allow delete: if resource != null && isOwner(resource.data.teacherId);
    }

    /**
     * @description Manages previous year question papers. All signed-in users can read them.
     *              Only the original uploader (or an admin) can manage them.
     * @path        /question_papers/{questionPaperId}
     * @allow       A student downloads a question paper. (get)
     * @deny        A user tries to create a paper and set the `uploaderId` to someone else. (create)
     * @principle   Enforces document ownership for writes and validates relational integrity on create.
     */
    match /question_papers/{questionPaperId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.uploaderId == request.auth.uid;
      allow update: if (resource != null && isOwner(resource.data.uploaderId)) || (isAdmin() && resource != null);
      allow delete: if (resource != null && isOwner(resource.data.uploaderId)) || (isAdmin() && resource != null);
    }

    /**
     * @description Manages global and class-wise notices. Readable by all signed-in users
     *              but can only be created or managed by Admins.
     * @path        /notices/{noticeId}
     * @allow       Any signed-in user reads a notice. (get)
     * @deny        A teacher tries to post a new notice. (create)
     * @principle   Restricts creation of authoritative content to Admins when no owner field exists.
     */
    match /notices/{noticeId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }
  }
}
